(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const n of c.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function i(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(o){if(o.ep)return;o.ep=!0;const c=i(o);fetch(o.href,c)}})();let d,F,Y=!1,I=!1,V=!1,O=0,$=100,b=[],S={start:null,end:null},s={active:!1,x:0,y:0,w:0,h:0,startTime:0,endTime:0,duration:.5,level:1,centerX:50,centerY:50},ce=!1,D={x:0,y:0},T={x:50,y:50,w:200,h:150,startTime:0,endTime:0},ge,ze=[],Be=!1,le=!1,Me=!1,Ce={x:0,y:0},v=[],He=1,E=null,me=null,Ie=!1,f=896,y=504,ae=1280,re=720,Te=ae/re,U=1,_="contain",Q=null,R=0,P=0,ye=!1,z,ee,L=null,W=null,j=null,Re=0,Pe=0,xe=0,Ae=0;const bt=60,wt=1e3/bt;function kt(){z=document.createElement("canvas"),z.width=f,z.height=y,ee=z.getContext("2d",{alpha:!1}),ee.imageSmoothingEnabled=!0,ee.imageSmoothingQuality="high",Ft();const e=document.getElementById("sketch-holder");e.innerHTML="",e.appendChild(z),d=document.createElement("video"),d.style.display="none",document.body.appendChild(d),F=document.createElement("video"),F.style.display="none",document.body.appendChild(F),Rt(),z.addEventListener("mousedown",Pt),z.addEventListener("mousemove",Xt),z.addEventListener("mouseup",Yt),St(),Ye(_),Jt(),rt(),Xe()}function Ft(){try{window.OffscreenCanvas?W=new OffscreenCanvas(f,y):(W=document.createElement("canvas"),W.width=f,W.height=y),j=W.getContext("2d",{alpha:!1}),j.imageSmoothingEnabled=!0,j.imageSmoothingQuality="high"}catch(e){console.error("Failed to initialize offscreen canvas:",e),W=null,j=null}}function St(){const e=document.createElement("div");e.id="fpsCounter",e.style.position="absolute",e.style.top="10px",e.style.right="10px",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.color="white",e.style.padding="5px",e.style.borderRadius="3px",e.style.fontSize="12px",e.style.fontFamily="monospace",e.style.display="none",e.textContent="FPS: 0";const t=document.getElementById("sketch-holder");t&&(t.style.position="relative",t.appendChild(e)),z.addEventListener("dblclick",zt)}function zt(){const e=document.getElementById("fpsCounter");e&&(e.style.display=e.style.display==="none"?"block":"none")}function w(e){if(!I)return;if(e){if(Re++,e-Pe>=1e3){xe=Math.round(Re*1e3/(e-Pe)),Re=0,Pe=e;const o=document.getElementById("fpsCounter");o&&(o.textContent=`FPS: ${xe}`,o.style.backgroundColor=xe>=55?"rgba(0, 128, 0, 0.7)":xe>=30?"rgba(255, 165, 0, 0.7)":"rgba(255, 0, 0, 0.7)")}if(e-Ae<wt){L=requestAnimationFrame(w);return}Ae=e}const t=j||ee;t.fillStyle="black",t.fillRect(0,0,f,y);const i=d.currentTime,r=v.find(o=>o.type==="Zoom"&&i>=o.startTime&&i<=o.endTime);if(r){let o;i<=r.startTime+r.data.duration?o=(i-r.startTime)/r.data.duration:i>=r.endTime-r.data.duration?o=1-(i-(r.endTime-r.data.duration))/r.data.duration:o=1,o=nt(o);const c=1+(r.data.level-1)*o,n=50+(r.data.centerX-50)*o,a=50+(r.data.centerY-50)*o,m=d.videoWidth/c,p=d.videoHeight/c,C=n/100*d.videoWidth,g=a/100*d.videoHeight,u=C-m/2,B=g-p/2,l=d.videoWidth/d.videoHeight,h=f/y;let M=f,N=y,q=0,A=0;_==="contain"?l>h?(N=f/l,A=(y-N)/2):(M=y*l,q=(f-M)/2):_==="cover"&&(l>h?(N=y,M=y*l,q=(f-M)/2):(M=f,N=f/l,A=(y-N)/2)),t.fillStyle="black",t.fillRect(0,0,f,y),t.drawImage(d,u,B,m,p,q,A,M,N)}else ct(d,0,0,f,y,t);if(Y&&d.currentTime>=$&&(d.currentTime=O),Y){for(let o of b)if(d.currentTime>=o.start&&d.currentTime<o.end){d.currentTime=o.end;break}}if(V&&d.currentTime>=T.startTime&&d.currentTime<=T.endTime){const o=T.x*U,c=T.y*U,n=T.w*U,a=T.h*U;t.drawImage(F,o,c,n,a)}if(ce&&ye&&(t.strokeStyle="red",t.lineWidth=2,t.strokeRect(D.x,D.y,R-D.x,P-D.y)),le&&E!==null){const o=v.find(c=>c.id===E);if(o&&o.type==="Zoom"){const c=o.data.level,n=f/c,a=y/c,m=o.data.centerX/100*f,p=o.data.centerY/100*y,C=m-n/2,g=p-a/2;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,f,g),t.fillRect(0,g+a,f,y-(g+a)),t.fillRect(0,g,C,a),t.fillRect(C+n,g,f-(C+n),a),t.strokeStyle="red",t.lineWidth=2,t.strokeRect(C,g,n,a);const u=10;t.beginPath(),t.moveTo(m-u,p),t.lineTo(m+u,p),t.moveTo(m,p-u),t.lineTo(m,p+u),t.stroke()}}j&&(ee.clearRect(0,0,f,y),ee.drawImage(W,0,0)),Ee(),(Y&&!d.paused||le||ue)&&(L=requestAnimationFrame(w))}function Rt(){document.getElementById("videoInput").addEventListener("change",function(n){const a=n.target.files[0];a&&(d.setAttribute("src",URL.createObjectURL(a)),d.setAttribute("data-filename",a.name),d.onloadedmetadata=()=>{I=!0,d.volume=0,document.getElementById("trimEnd").value=100,$=d.duration,document.getElementById("trimEndValue").textContent=$.toFixed(1),et(),Ee(),w()})}),document.getElementById("overlayInput").addEventListener("change",function(n){const a=n.target.files[0];a&&(F.setAttribute("src",URL.createObjectURL(a)),F.onloadedmetadata=()=>{V=!0,F.volume=0})}),document.getElementById("playPauseBtn").addEventListener("click",()=>{I&&(Y?(d.pause(),V&&F.pause(),Y=!1,document.getElementById("playIcon").classList.remove("hidden"),document.getElementById("pauseIcon").classList.add("hidden"),cancelAnimationFrame(L)):(d.play(),V&&F.play(),Y=!0,document.getElementById("playIcon").classList.add("hidden"),document.getElementById("pauseIcon").classList.remove("hidden"),w()))}),document.getElementById("resetBtn").addEventListener("click",()=>{I&&(d.currentTime=O,V&&(F.currentTime=0),Y=!1,document.getElementById("playIcon").classList.remove("hidden"),document.getElementById("pauseIcon").classList.add("hidden"))}),document.getElementById("trimStart").addEventListener("input",function(){if(I){const n=parseFloat(this.value);O=ie(n,0,100,0,d.duration),document.getElementById("trimStartValue").textContent=O.toFixed(1),d.currentTime=O}}),document.getElementById("trimEnd").addEventListener("input",function(){if(I){const n=parseFloat(this.value);$=ie(n,0,100,0,d.duration),document.getElementById("trimEndValue").textContent=$.toFixed(1)}}),document.getElementById("markCutStart").addEventListener("click",()=>{I&&(S.start=d.currentTime,alert(`Cut start marked at ${S.start.toFixed(2)}s`))}),document.getElementById("markCutEnd").addEventListener("click",()=>{I&&S.start!==null?(S.end=d.currentTime,S.end>S.start?alert(`Cut end marked at ${S.end.toFixed(2)}s`):(alert("End time must be after start time"),S.end=null)):alert("Please mark cut start first")}),document.getElementById("addCut").addEventListener("click",()=>{S.start!==null&&S.end!==null?(b.push({start:S.start,end:S.end}),Ut("Cut",S.start,S.end),de(),S={start:null,end:null}):alert("Please mark both start and end points")}),document.getElementById("clearCuts").addEventListener("click",()=>{b=[],v=v.filter(n=>n.type!=="Cut"),de(),X()}),document.getElementById("setZoomRegion").addEventListener("click",()=>{ce=!0,alert("Click and drag on the video to set zoom region")}),document.getElementById("clearZoom").addEventListener("click",()=>{s.active=!1,v=v.filter(n=>n.type!=="Zoom"),X()}),document.getElementById("markZoomStart").addEventListener("click",()=>{if(I){const n=d.currentTime;s.startTime=n;const a=ie(n,0,d.duration,0,100);document.getElementById("zoomStartTime").value=a,document.getElementById("zoomStartValue").textContent=n.toFixed(1)}}),document.getElementById("markZoomEnd").addEventListener("click",()=>{if(I){const n=d.currentTime;if(n<=s.startTime){alert("End time must be after start time");return}s.endTime=n;const a=ie(n,0,d.duration,0,100);document.getElementById("zoomEndTime").value=a,document.getElementById("zoomEndValue").textContent=n.toFixed(1)}}),document.getElementById("zoomStartTime").addEventListener("input",function(){if(I){const n=parseFloat(this.value);s.startTime=n,document.getElementById("zoomStartValue").textContent=s.startTime.toFixed(1)}}),document.getElementById("zoomEndTime").addEventListener("input",function(){if(I){const n=parseFloat(this.value);s.endTime=n,document.getElementById("zoomEndValue").textContent=s.endTime.toFixed(1)}}),document.getElementById("overlayStartTime").addEventListener("input",function(){if(I){const n=parseFloat(this.value);T.startTime=ie(n,0,100,0,d.duration),document.getElementById("overlayStartValue").textContent=T.startTime.toFixed(1)}}),document.getElementById("overlayEndTime").addEventListener("input",function(){if(I){const n=parseFloat(this.value);T.endTime=ie(n,0,100,0,d.duration),document.getElementById("overlayEndValue").textContent=T.endTime.toFixed(1)}}),document.getElementById("overlayX").addEventListener("input",function(){T.x=parseInt(this.value),document.getElementById("overlayXValue").textContent=T.x}),document.getElementById("overlayY").addEventListener("input",function(){T.y=parseInt(this.value),document.getElementById("overlayYValue").textContent=T.y}),document.getElementById("overlayWidth").addEventListener("input",function(){T.w=parseInt(this.value),document.getElementById("overlayWidthValue").textContent=T.w}),document.getElementById("overlayHeight").addEventListener("input",function(){T.h=parseInt(this.value),document.getElementById("overlayHeightValue").textContent=T.h});const e=document.getElementById("exportOptionsBtn"),t=document.getElementById("exportOptionsPopup");e.addEventListener("click",n=>{n.stopPropagation(),t.classList.toggle("hidden"),resolutionPopup.classList.add("hidden")}),document.addEventListener("click",n=>{!t.contains(n.target)&&n.target!==e&&t.classList.add("hidden")}),document.getElementById("fitContain").addEventListener("click",()=>{Ye("contain")}),document.getElementById("fitCover").addEventListener("click",()=>{Ye("cover")}),Dt(),document.getElementById("addZoomBtn").addEventListener("click",Qt),document.getElementById("addCutBtn").addEventListener("click",_t),["zoomStartTime","zoomEndTime","zoomLevel","zoomCenterX","zoomCenterY","zoomDuration"].forEach(n=>{document.getElementById(n).addEventListener("input",function(){if(E===null)return;const a=v.find(p=>p.id===E);if(!a||a.type!=="Zoom")return;const m=parseFloat(this.value);switch(n){case"zoomStartTime":a.startTime=m;break;case"zoomEndTime":a.endTime=m;break;case"zoomLevel":a.data.level=m;break;case"zoomCenterX":a.data.centerX=m;break;case"zoomCenterY":a.data.centerY=m;break;case"zoomDuration":a.data.duration=m;break}s.startTime=a.startTime,s.endTime=a.endTime,s.level=a.data.level,s.centerX=a.data.centerX,s.centerY=a.data.centerY,s.duration=a.data.duration,se(),X()})}),document.getElementById("cutStartTime").addEventListener("input",function(){if(E===null)return;const n=v.find(m=>m.id===E);if(!n||n.type!=="Cut")return;n.startTime=parseFloat(this.value);const a=b.findIndex(m=>m.id===n.id);a!==-1?b[a].start=n.startTime:b.push({id:n.id,start:n.startTime,end:n.endTime}),de(),X()}),document.getElementById("cutEndTime").addEventListener("input",function(){if(E===null)return;const n=v.find(m=>m.id===E);if(!n||n.type!=="Cut")return;n.endTime=parseFloat(this.value);const a=b.findIndex(m=>m.id===n.id);a!==-1?b[a].end=n.endTime:b.push({id:n.id,start:n.startTime,end:n.endTime}),de(),X()}),document.getElementById("importVideoBtn").addEventListener("click",()=>{document.getElementById("videoInput").click()}),document.getElementById("exportVideoBtn").addEventListener("click",async()=>{if(!I){alert("Please load a video first");return}if(Ie)return;Ie=!0;const n=document.getElementById("exportVideoBtn"),a=document.getElementById("exportSpinner"),m=document.getElementById("exportBtnText");if(n.disabled=!0,n.style.setProperty("--progress-width","0%"),n.classList.add("exporting"),!document.getElementById("exportBtnProgressStyle")){const u=document.createElement("style");u.id="exportBtnProgressStyle",u.textContent=`
                .exporting {
                    position: relative;
                    overflow: hidden;
                }
                .exporting::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    height: 100%;
                    width: var(--progress-width, 0%);
                    background-color: rgba(75, 85, 99, 0.5);
                    border-radius: inherit;
                    z-index: 0;
                    transition: width 0.3s ease;
                }
                .exporting span {
                    position: relative;
                    z-index: 1;
                }
            `,document.head.appendChild(u)}a.classList.add("hidden"),m.textContent="Exporting...";const p=document.getElementById("exportProgress"),C=document.getElementById("exportProgressBar"),g=document.getElementById("exportStatus");p.classList.remove("hidden"),C.style.width="0%",g.textContent="Preparing...",document.getElementById("exportOptionsPopup").classList.remove("hidden");try{if(!Q){const{createFFmpeg:x,fetchFile:Z}=FFmpeg;Q=x({log:!0}),await Q.load(),g.textContent="FFmpeg loaded"}const u=document.getElementById("exportResolution"),B=document.getElementById("exportFormat");let l,h;const M=u.value,N=B.value;if(M==="original")l=d.videoWidth,h=d.videoHeight;else{const x=M.split("x");l=parseInt(x[0]),h=parseInt(x[1])}const q=document.createElement("canvas");q.width=l,q.height=h;const A=q.getContext("2d");d.currentTime=O,V&&(F.currentTime=0);const lt=[...b].sort((x,Z)=>x.start-Z.start);let G=[],fe=O;for(const x of lt){if(x.end<=O||x.start>=$)continue;const Z=Math.max(x.start,O),we=Math.min(x.end,$);Z>fe&&G.push({start:fe,end:Z}),fe=we}if(fe<$&&G.push({start:fe,end:$}),G.length===0){alert("No content to export after applying all cuts"),Ie=!1,a.classList.add("hidden"),m.textContent="Export",p.classList.add("hidden");return}g.textContent="Processing video frames...";const ve=30,mt=G.reduce((x,Z)=>x+(Z.end-Z.start),0),ut=Math.ceil(mt*ve);let he=0;for(let x=0;x<G.length;x++){const Z=G[x],we=Z.end-Z.start,Et=Math.ceil(we*ve);g.textContent=`Processing segment ${x+1}/${G.length}...`;for(let ke=0;ke<Et;ke++){const K=Z.start+ke/ve;d.currentTime=K,await new Promise(k=>{const pe=()=>{d.removeEventListener("seeked",pe),k()};d.addEventListener("seeked",pe)}),A.fillStyle="black",A.fillRect(0,0,l,h);const H=v.find(k=>k.type==="Zoom"&&K>=k.startTime&&K<=k.endTime);if(H){let k;K<=H.startTime+H.data.duration?k=(K-H.startTime)/H.data.duration:K>=H.endTime-H.data.duration?k=1-(K-(H.endTime-H.data.duration))/H.data.duration:k=1,k=nt(k);const pe=1+(H.data.level-1)*k,It=50+(H.data.centerX-50)*k,xt=50+(H.data.centerY-50)*k,Oe=d.videoWidth/pe,Ne=d.videoHeight/pe,Bt=It/100*d.videoWidth,Ct=xt/100*d.videoHeight,Tt=Bt-Oe/2,Lt=Ct-Ne/2,te=d.videoWidth/d.videoHeight,Ve=l/h;let ne=l,oe=h,Fe=0,Se=0;_==="contain"?te>Ve?(oe=l/te,Se=(h-oe)/2):(ne=h*te,Fe=(l-ne)/2):_==="cover"&&(te>Ve?(oe=h,ne=h*te,Fe=(l-ne)/2):(ne=l,oe=l/te,Se=(h-oe)/2)),A.fillStyle="black",A.fillRect(0,0,l,h),A.drawImage(d,Tt,Lt,Oe,Ne,Fe,Se,ne,oe)}else ct(d,0,0,l,h,A);const vt=q.toDataURL("image/jpeg",.95),ht=await fetch(vt).then(k=>k.arrayBuffer());Q.FS("writeFile",`frame${he.toString().padStart(6,"0")}.jpg`,new Uint8Array(ht)),he++;const Ze=he/ut*50;C.style.width=`${Ze}%`,n.style.setProperty("--progress-width",`${Ze}%`)}}g.textContent="Encoding video...";const Le=`output.${N}`,ft=N==="mp4"?"libx264":"libvpx";await Q.run("-framerate",ve.toString(),"-i","frame%06d.jpg","-c:v",ft,"-pix_fmt","yuv420p",Le),C.style.width="75%",n.style.setProperty("--progress-width","75%"),g.textContent="Finalizing export...";const pt=Q.FS("readFile",Le),gt=new Blob([pt.buffer],{type:`video/${N}`}),We=URL.createObjectURL(gt),be=document.createElement("a");be.href=We;const yt=(d.getAttribute("data-filename")||"edited-video").replace(/\.[^/.]+$/,"")+`-edited-${l}x${h}.${N}`;be.download=yt,be.click(),URL.revokeObjectURL(We);for(let x=0;x<he;x++)Q.FS("unlink",`frame${x.toString().padStart(6,"0")}.jpg`);Q.FS("unlink",Le),C.style.width="100%",n.style.setProperty("--progress-width","100%"),g.textContent="Export complete!",setTimeout(()=>{C.style.width="0%",p.classList.add("hidden"),g.textContent="",n.classList.remove("exporting"),n.style.removeProperty("--progress-width")},3e3)}catch(u){console.error("Export error:",u),alert("Error during export: "+u.message),g.textContent=`Export failed: ${u.message}`,n.classList.remove("exporting"),n.style.removeProperty("--progress-width")}finally{Ie=!1,n.disabled=!1,m.textContent="Export"}}),document.getElementById("videoInput").addEventListener("change",function(n){n.target.files.length>0&&(document.getElementById("importVideoBtn").textContent="Change Video")}),document.getElementById("resolutionMenuBtn").addEventListener("click",function(n){document.getElementById("resolutionPopup").classList.toggle("hidden"),n.stopPropagation()}),document.addEventListener("click",function(n){const a=document.getElementById("resolutionPopup"),m=document.getElementById("resolutionMenuBtn");!a.contains(n.target)&&n.target!==m&&a.classList.add("hidden")}),document.getElementById("res720p").addEventListener("click",()=>J(1280,720)),document.getElementById("res1080p").addEventListener("click",()=>J(1920,1080)),document.getElementById("res1440p").addEventListener("click",()=>J(2560,1440)),document.getElementById("res4k").addEventListener("click",()=>J(3840,2160)),document.getElementById("resMobile720p").addEventListener("click",()=>J(720,1280)),document.getElementById("resMobile1080p").addEventListener("click",()=>J(1080,1920)),document.getElementById("resMobileStory").addEventListener("click",()=>J(1080,1920)),document.getElementById("applyCustomRes").addEventListener("click",Kt),document.getElementById("maintainAspectRatio").addEventListener("change",function(){const n=document.getElementById("customWidth"),a=document.getElementById("customHeight");if(this.checked){const m=parseInt(n.value),p=parseInt(a.value);!isNaN(m)&&!isNaN(p)&&(Te=m/p),n.addEventListener("input",qe),a.addEventListener("input",Qe)}else n.removeEventListener("input",qe),a.removeEventListener("input",Qe)}),Wt();const o=document.getElementById("startRecording");o&&o.addEventListener("click",Vt);const c=document.getElementById("stopRecording");c&&c.addEventListener("click",At)}function Pt(e){const t=z.getBoundingClientRect();R=e.clientX-t.left,P=e.clientY-t.top,ye=!0,Mt()}function Xt(e){const t=z.getBoundingClientRect();R=e.clientX-t.left,P=e.clientY-t.top,ye&&(Ht(),L||w())}function Yt(e){const t=z.getBoundingClientRect();R=e.clientX-t.left,P=e.clientY-t.top,ye=!1,$t()}function Mt(){if(ce&&R>=0&&R<=f&&P>=0&&P<=y)D.x=R,D.y=P;else if(le&&I&&E!==null){const e=v.find(t=>t.id===E);if(e&&e.type==="Zoom"){const t=e.data.level,i=f/t,r=y/t,o=e.data.centerX/100*f,c=e.data.centerY/100*y,n=o-i/2,a=c-r/2;R>=n&&R<=n+i&&P>=a&&P<=a+r&&(Me=!0,Ce.x=R-o,Ce.y=P-c)}}}function Ht(){if(Me&&E!==null){const e=v.find(m=>m.id===E);if(!e||e.type!=="Zoom")return;let t=R-Ce.x,i=P-Ce.y;const r=e.data.level,o=f/r,c=y/r;t=Ge(t,o/2,f-o/2),i=Ge(i,c/2,y-c/2);const n=t/f*100,a=i/y*100;document.getElementById("zoomCenterX").value=n,document.getElementById("zoomCenterY").value=a,e.data.centerX=n,e.data.centerY=a,s.centerX=n,s.centerY=a,se(),L||w()}else ce&&ye&&(L||w())}function $t(){if(ce&&R>=0&&R<=f&&P>=0&&P<=y){const e=Ke(D.x,R),t=Ke(D.y,P),i=Je(D.x,R),r=Je(D.y,P),o=je(e,t),c=je(i-e,r-t);s.x=o.x,s.y=o.y,s.w=c.x,s.h=c.y,s.active=!0,ce=!1}Me=!1}function et(){I&&(d.duration,document.getElementById("zoomStartTime").max=100,document.getElementById("zoomEndTime").max=100,document.getElementById("overlayStartTime").max=100,document.getElementById("overlayEndTime").max=100)}function de(){const e=document.getElementById("cutsList");e.innerHTML="",b.forEach((t,i)=>{const r=document.createElement("div");r.textContent=`Cut ${i+1}: ${t.start.toFixed(2)}s - ${t.end.toFixed(2)}s`,e.appendChild(r)})}function Ee(){const e=document.getElementById("timeline"),t=document.getElementById("current-time-display"),i=document.getElementById("time-indicator"),r=document.getElementById("time-handle"),o=document.getElementById("timeline-progress");if(!I||!e||!t)return;const c=d.duration,n=d.currentTime;t.innerHTML=`<span style="color: var(--color-text-highlight); font-family: monospace">${_e(n)}</span> / <span style="color: var(--color-text); font-family: monospace">${_e(c)}</span>`;const a=n/c,m=a*e.offsetWidth;o&&(o.style.width=`${a*100}%`),i&&(i.style.left=`${m}px`),r&&(r.style.left=`${m}px`),document.querySelectorAll(".cut-indicator").forEach(u=>{const B=u.id,l=B?parseInt(B.replace("cut-","")):null;(!l||!b.find(h=>h.id===l))&&u.remove()}),b.forEach(u=>{const B=`cut-${u.id}`;let l=document.getElementById(B);l||(l=document.createElement("div"),l.id=B,l.className="cut-indicator",e.appendChild(l));const h=u.start/c*100,M=(u.end-u.start)/c*100;l.style.left=`${h}%`,l.style.width=`${M}%`});const C=v.filter(u=>u.type==="Zoom");document.querySelectorAll(".zoom-indicator").forEach(u=>{const B=u.id,l=B?parseInt(B.replace("zoom-","")):null;(!l||!C.find(h=>h.id===l))&&u.remove()}),C.forEach(u=>{const B=`zoom-${u.id}`;let l=document.getElementById(B);l||(l=document.createElement("div"),l.id=B,l.className="zoom-indicator",e.appendChild(l));const h=u.startTime/c*100,M=(u.endTime-u.startTime)/c*100;l.style.left=`${h}%`,l.style.width=`${M}%`})}let ue=!1,tt=!1;function Wt(){const e=document.getElementById("timeline"),t=document.getElementById("time-handle");e&&(e.addEventListener("mousedown",De),document.addEventListener("mousemove",Zt),document.addEventListener("mouseup",Ot),t&&t.addEventListener("mousedown",i=>{i.stopPropagation(),De(i)}),e.addEventListener("click",Nt))}function De(e){I&&(ue=!0,tt=Y,Y&&(d.pause(),V&&F.pause()),$e(e),L||(L=requestAnimationFrame(w)))}function Zt(e){ue&&$e(e)}function Ot(e){ue&&(ue=!1,tt?(d.play(),V&&F.play(),Y=!0,document.getElementById("playIcon").classList.add("hidden"),document.getElementById("pauseIcon").classList.remove("hidden")):L&&!Y&&!le&&(cancelAnimationFrame(L),L=null))}function Nt(e){!I||ue||$e(e)}function $e(e){const i=document.getElementById("timeline").getBoundingClientRect(),c=(e.clientX-i.left)/i.width*d.duration,n=Math.max(0,Math.min(c,d.duration));d.currentTime=n;for(let a of b)if(n>=a.start&&n<a.end){d.currentTime=a.end;break}n<O?d.currentTime=O:n>$&&(d.currentTime=$),w()}function Vt(){if(!I){alert("Please load a video first");return}if(Be){alert("Already recording");return}d.currentTime=O,V&&(F.currentTime=0);const e=document.querySelector("canvas").captureStream();ge=new MediaRecorder(e),ze=[],ge.ondataavailable=t=>ze.push(t.data),ge.onstop=()=>{const t=new Blob(ze,{type:"video/webm"}),i=URL.createObjectURL(t),r=document.createElement("a");r.href=i,r.download="edited-video.webm",r.click(),URL.revokeObjectURL(i)},ge.start(),d.play(),V&&F.play(),Y=!0,Be=!0,document.getElementById("playIcon").classList.add("hidden"),document.getElementById("pauseIcon").classList.remove("hidden"),alert("Recording started. Press 'Stop Recording' when finished.")}function At(){if(!Be){alert("Not currently recording");return}ge.stop(),d.pause(),V&&F.pause(),Y=!1,Be=!1,document.getElementById("playIcon").classList.remove("hidden"),document.getElementById("pauseIcon").classList.add("hidden"),alert("Recording stopped. Download will start automatically.")}function Dt(){document.getElementById("zoomDuration").addEventListener("input",function(){const e=parseFloat(this.value);if(E!==null){const t=v.find(i=>i.id===E);t&&t.type==="Zoom"&&(t.data.duration=e,s.duration=e,X())}}),document.getElementById("zoomLevel").addEventListener("input",function(){const e=parseFloat(this.value);if(E!==null){const t=v.find(i=>i.id===E);t&&t.type==="Zoom"&&(t.data.level=e,s.level=e,se(),X())}}),document.getElementById("zoomCenterX").addEventListener("input",function(){const e=parseFloat(this.value);if(E!==null){const t=v.find(i=>i.id===E);t&&t.type==="Zoom"&&(t.data.centerX=e,s.centerX=e,se(),X())}}),document.getElementById("zoomCenterY").addEventListener("input",function(){const e=parseFloat(this.value);if(E!==null){const t=v.find(i=>i.id===E);t&&t.type==="Zoom"&&(t.data.centerY=e,s.centerY=e,se(),X())}}),document.getElementById("showZoomRegion").addEventListener("change",function(){le=this.checked,le?L||w():!Y&&L&&(cancelAnimationFrame(L),L=null),w()})}function se(){if(!I)return;const e=s.level,t=f/e,i=y/e,r=s.centerX/100*f,o=s.centerY/100*y;if(s.x=r-t/2,s.y=o-i/2,s.w=t,s.h=i,s.active=!0,E!==null&&me==="Zoom"){const c=v.find(n=>n.id===E);c&&(c.startTime=s.startTime,c.endTime=s.endTime,c.data={level:s.level,centerX:s.centerX,centerY:s.centerY,duration:s.duration})}X(),Ee(),L||w()}function nt(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}function Ue(e){const t=Math.floor(e/60),i=(e%60).toFixed(1);return`${t}:${i.padStart(4,"0")}`}function X(){const e=document.getElementById("editsTable");e.innerHTML="",v.forEach(t=>{const i=document.createElement("tr");i.className="border-b border-text/10";const r=document.createElement("td");r.className="py-2 px-4",r.textContent=t.id;const o=document.createElement("td");o.className="py-2 px-4",o.textContent=t.type;const c=document.createElement("td");c.className="py-2 px-4",c.textContent=Ue(t.startTime);const n=document.createElement("td");n.className="py-2 px-4",n.textContent=Ue(t.endTime);const a=document.createElement("td");a.className="py-2 px-4";const m=document.createElement("button");m.className="bg-button hover:bg-button/80 text-text py-1 px-2 rounded mr-2 text-xs",m.textContent="Edit",m.addEventListener("click",()=>qt(t.id));const p=document.createElement("button");p.className="bg-red-500/50 hover:bg-red-500/70 text-text py-1 px-2 rounded text-xs",p.textContent="Delete",p.addEventListener("click",()=>jt(t.id)),a.appendChild(m),a.appendChild(p),i.appendChild(r),i.appendChild(o),i.appendChild(c),i.appendChild(n),i.appendChild(a),e.appendChild(i)})}function Ut(e,t,i,r={}){const o={id:He++,type:e,startTime:t,endTime:i,...r};v.push(o),X()}function jt(e){const t=v.findIndex(r=>r.id===e);if(t===-1)return;const i=v[t];v.splice(t,1),i.type==="Zoom"?E===e&&(s.active=!1,E=null,me=null,Xe()):i.type==="Cut"&&(b=b.filter(r=>r.id!==i.id),E===e&&(E=null,me=null,Xe()),de()),I&&w(),X(),Ee()}function qt(e){const t=v.find(i=>i.id===e);t&&(E=t.id,me=t.type,d.currentTime=t.startTime,t.type==="Zoom"?(s.startTime=t.startTime,s.endTime=t.endTime,s.level=t.data.level,s.centerX=t.data.centerX,s.centerY=t.data.centerY,s.duration=t.data.duration,s.active=!0,ot(),dt(t)):t.type==="Cut"&&(it(),at(t)))}function ot(){document.getElementById("zoomConfig").classList.remove("hidden"),document.getElementById("cutConfig").classList.add("hidden"),document.getElementById("noEditMessage").classList.add("hidden")}function it(){document.getElementById("zoomConfig").classList.add("hidden"),document.getElementById("cutConfig").classList.remove("hidden"),document.getElementById("noEditMessage").classList.add("hidden")}function Xe(){document.getElementById("zoomConfig").classList.add("hidden"),document.getElementById("cutConfig").classList.add("hidden"),document.getElementById("noEditMessage").classList.remove("hidden")}function Qt(){const e=d.currentTime,t={id:He++,type:"Zoom",startTime:e,endTime:e+2,data:{level:2,centerX:50,centerY:50,duration:.5}};v.push(t),E=t.id,me="Zoom",s.startTime=t.startTime,s.endTime=t.endTime,s.level=t.data.level,s.centerX=t.data.centerX,s.centerY=t.data.centerY,s.duration=t.data.duration,s.active=!0,ot(),dt(t),se(),X()}function _t(){const e=d.currentTime,t={id:He++,type:"Cut",startTime:e,endTime:e+1};b.push({id:t.id,start:t.startTime,end:t.endTime}),v.push(t),E=t.id,me="Cut",it(),at(t),de(),X()}function dt(e){document.getElementById("zoomStartTime").value=e.startTime,document.getElementById("zoomEndTime").value=e.endTime,document.getElementById("zoomLevel").value=e.data.level,document.getElementById("zoomCenterX").value=e.data.centerX,document.getElementById("zoomCenterY").value=e.data.centerY,document.getElementById("zoomDuration").value=e.data.duration,L||w()}function at(e){document.getElementById("cutStartTime").value=e.startTime,document.getElementById("cutEndTime").value=e.endTime}function rt(){const e=f/ae,t=y/re;U=Math.min(e,t),f=Math.floor(ae*U),y=Math.floor(re*U),Gt(f,y)}function Gt(e,t){z&&(z.width=e,z.height=t,W&&(window.OffscreenCanvas&&W instanceof OffscreenCanvas?W=new OffscreenCanvas(e,t):(W.width=e,W.height=t),j=W.getContext("2d",{alpha:!1}),j.imageSmoothingEnabled=!0,j.imageSmoothingQuality="high"),L||w())}function st(e,t){ae=e,re=t,Te=ae/re,rt(),document.getElementById("currentResolution").textContent=`${ae}×${re}`}function je(e,t){return{x:e/U,y:t/U}}function J(e,t){document.getElementById("customWidth").value=e,document.getElementById("customHeight").value=t,st(e,t)}function Kt(){const e=parseInt(document.getElementById("customWidth").value),t=parseInt(document.getElementById("customHeight").value);if(isNaN(e)||isNaN(t)||e<100||t<100){alert("Please enter valid dimensions (minimum 100x100)");return}(e>7680||t>4320)&&!confirm("Very large resolutions may cause performance issues. Continue?")||st(e,t)}function qe(){if(!document.getElementById("maintainAspectRatio").checked)return;const e=parseInt(document.getElementById("customWidth").value);if(!isNaN(e)){const t=Math.round(e/Te);document.getElementById("customHeight").value=t}}function Qe(){if(!document.getElementById("maintainAspectRatio").checked)return;const e=parseInt(document.getElementById("customHeight").value);if(!isNaN(e)){const t=Math.round(e*Te);document.getElementById("customWidth").value=t}}function ct(e,t,i,r,o,c){if(!e)return;const n=c||ee,a=e.videoWidth,m=e.videoHeight,p=a/m,C=r/o;if(n.fillStyle="black",n.fillRect(t,i,r,o),_==="contain"){let g,u;p>C?(g=r,u=r/p):(u=o,g=o*p);const B=(r-g)/2,l=(o-u)/2;n.drawImage(e,t+B,i+l,g,u)}else if(_==="cover"){let g,u;p>C?(u=o,g=o*p):(g=r,u=r/p);const B=(r-g)/2,l=(o-u)/2;n.drawImage(e,t+B,i+l,g,u)}}function Ye(e){_=e;const t=document.getElementById("fitContain"),i=document.getElementById("fitCover");e==="contain"?(t.classList.add("active-option"),i.classList.remove("active-option")):e==="cover"&&(i.classList.add("active-option"),t.classList.remove("active-option")),I&&w()}function _e(e){const t=Math.floor(e/3600),i=Math.floor(e%3600/60),r=Math.floor(e%60),o=Math.floor(e%1*1e3);return e>=3600?`${t}:${i.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}.${o.toString().padStart(3,"0")}`:`${i}:${r.toString().padStart(2,"0")}.${o.toString().padStart(3,"0")}`}function Ge(e,t,i){return Math.max(t,Math.min(i,e))}function Ke(e,t){return Math.min(e,t)}function Je(e,t){return Math.max(e,t)}function ie(e,t,i,r,o){return r+(o-r)*((e-t)/(i-t))}function Jt(){const t=document.getElementById("videoInput").getAttribute("data-default-video");t&&(d.src=t,d.onloadedmetadata=()=>{I=!0,d.volume=0,document.getElementById("trimEnd").value=100,$=d.duration,document.getElementById("trimEndValue").textContent=$.toFixed(1),et(),Ee(),w()})}document.addEventListener("DOMContentLoaded",()=>{kt()});
